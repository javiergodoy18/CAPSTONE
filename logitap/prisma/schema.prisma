generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Vehicle {
  id          String     @id @default(uuid())
  plate       String     @unique
  brand       String
  model       String
  year        Int
  type        String
  capacity    Float
  status      String     @default("available")
  fuelType    String?
  mileage     Float?
  lastService DateTime?
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  dispatches  Dispatch[]

  @@map("vehicles")
}

model Driver {
  id         String     @id @default(uuid())
  name       String
  email      String     @unique
  phone      String
  license    String
  status     String     @default("available")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  dispatches Dispatch[]
  user       User?

  @@map("drivers")
}

model Laboratory {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  phone         String
  address       String
  city          String
  contactPerson String?
  businessType  String   @default("laboratory")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  latitude      Float?
  longitude     Float?
  pickups       Pickup[]

  @@map("laboratories")
}

model Pharmacy {
  id            String     @id @default(uuid())
  name          String
  rut           String?    @unique
  email         String     @unique
  phone         String
  address       String
  city          String
  contactPerson String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deliveryZone  String?
  latitude      Float?
  longitude     Float?
  deliveries    Delivery[]

  @@map("pharmacies")
}

model Dispatch {
  id                    String     @id @default(uuid())
  dispatchNumber        String     @unique
  vehicleId             String?
  driverId              String?
  status                String     @default("scheduled")
  generalNotes          String?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  actualEndDate         DateTime?
  actualStartDate       DateTime?
  scheduledEndDate      DateTime?
  scheduledStartDate    DateTime
  totalIncome           Float      @default(0)
  totalMerchandiseValue Float      @default(0)
  deliveries            Delivery[]
  driver                Driver?    @relation(fields: [driverId], references: [id])
  vehicle               Vehicle?   @relation(fields: [vehicleId], references: [id])
  pickups               Pickup[]

  @@map("dispatches")
}

model Pickup {
  id                String     @id @default(uuid())
  dispatchId        String
  laboratoryId      String
  pickupAddress     String
  pickupDate        DateTime
  actualPickupTime  DateTime?
  merchandiseValue  Float      @default(0)
  dispatchCost      Float?
  pricingType       String     @default("percentage")
  percentageApplied Float?
  customPrice       Float?
  pickupNotes       String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  deliveries        Delivery[]
  dispatch          Dispatch   @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  laboratory        Laboratory @relation(fields: [laboratoryId], references: [id])

  @@map("pickups")
}

model Delivery {
  id                 String    @id @default(uuid())
  dispatchId         String
  pharmacyId         String
  invoiceNumber      String
  merchandiseValue   Float
  orderInRoute       Int       @default(0)
  actualOrder        Int?
  productType        String    @default("medicamentos")
  weight             Float?
  packages           Int?
  latitude           Float?
  longitude          Float?
  status             String    @default("pending")
  deliveredAt        DateTime?
  deliveryNotes      String?
  deliveryProof      String?
  recipientName      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  pickupId           String
  isCustomPricing    Boolean   @default(false)
  customPriceConcept String?
  customPriceAmount  Float?
  dispatch           Dispatch  @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  pharmacy           Pharmacy  @relation(fields: [pharmacyId], references: [id])
  pickup             Pickup    @relation(fields: [pickupId], references: [id], onDelete: Cascade)

  @@map("deliveries")
}

model User {
  id           String               @id @default(uuid())
  email        String               @unique
  password     String
  name         String
  role         UserRole             @default(DRIVER)
  driverId     String?              @unique
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  profileImage String?
  resetTokens  PasswordResetToken[]
  sessions     Session[]
  driver       Driver?              @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([role])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

enum UserRole {
  ADMIN
  DRIVER
}
